name: Build Pinpoint 3.0.3 from Maven

on:
  workflow_dispatch: # 手动点击触发

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Collector 配置 ---
          - service: collector
            image_name: pinpoint-collector-boot
            # Maven Central 下载地址
            download_url: https://repo1.maven.org/maven2/com/navercorp/pinpoint/pinpoint-collector-starter/3.0.3/pinpoint-collector-starter-3.0.3-exec.jar
          
          # --- Web 配置 ---
          - service: web
            image_name: pinpoint-web-boot
            # Maven Central 下载地址
            download_url: https://repo1.maven.org/maven2/com/navercorp/pinpoint/pinpoint-web-starter/3.0.3/pinpoint-web-starter-3.0.3-exec.jar

    steps:
      # 1. 设置 QEMU (支持 ARM64)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. 设置 Docker Buildx (支持多架构构建)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 登录 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. 从 Maven Central 下载 Jar 包
      - name: Download JAR from Maven
        run: |
          echo "Downloading from: ${{ matrix.download_url }}"
          curl -L -o app.jar "${{ matrix.download_url }}"
          ls -lh app.jar

      # 5. 动态生成 Dockerfile (基于 JDK 17)
      - name: Generate Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM eclipse-temurin:17-jre
          
          WORKDIR /app
          
          # 复制刚才下载的 jar 包
          COPY app.jar app.jar
          
          # 设置时区
          ENV TZ=Asia/Shanghai
          
          # 启动命令
          ENTRYPOINT ["java", "-jar", "app.jar"]
          EOF

      # 6. 构建并推送 (AMD64 + ARM64)
      - name: Build and Push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          # 同时构建 x86 和 ARM 架构
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image_name }}:3.0.3
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image_name }}:latest
