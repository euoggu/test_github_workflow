name: build redis-benchmark arm64 (glibc 2.28 compatible)

on:
  workflow_dispatch:
    inputs:
      redis_ref:
        description: "Redis version/tag/branch/commit (e.g. 7.4.0)"
        required: false
        default: "7.4.0"

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    container:
      image: registry.access.redhat.com/ubi8/ubi-minimal:8.10

    steps:
      - name: Install build deps (UBI8 minimal)
        run: |
          microdnf -y update
          microdnf -y install \
            git make gcc gcc-c++ glibc-devel \
            tar gzip which file \
            findutils diffutils

      - name: Checkout Redis source
        run: |
          git clone --depth 1 --branch "${{ inputs.redis_ref }}" https://github.com/redis/redis.git
          cd redis
          git rev-parse HEAD

      - name: Build redis-benchmark
        run: |
          cd redis
          make -j"$(nproc)" redis-benchmark
          file src/redis-benchmark
          ldd src/redis-benchmark || true
          strings -a src/redis-benchmark | grep -Eo 'GLIBC_[0-9]+\.[0-9]+' | sort -Vu | tail -n 30 || true

      - name: Package artifact
        run: |
          cd redis
          mkdir -p dist
          cp -f src/redis-benchmark dist/
          {
            echo "redis_ref=${{ inputs.redis_ref }}"
            echo "sha=$(git rev-parse HEAD)"
            echo "build_container=ubi8/ubi-minimal:8.10 (glibc 2.28 baseline)"
            echo "arch=$(uname -m)"
          } > dist/build-info.txt
          tar -C dist -czf redis-benchmark-aarch64-glibc228-${{ inputs.redis_ref }}.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: redis-benchmark-aarch64-glibc228-${{ inputs.redis_ref }}
          path: redis-benchmark-aarch64-glibc228-${{ inputs.redis_ref }}.tar.gz
          if-no-files-found: error
          retention-days: 14
