name: build redis-benchmark arm64 (glibc 2.28 compatible)

on:
  workflow_dispatch:
    inputs:
      redis_ref:
        description: "Redis version/tag/branch/commit (e.g. 7.4.0)"
        required: false
        default: "7.4.0"

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    container:
      image: rockylinux:8

    steps:
      - name: Install build deps (Rocky Linux 8)
        run: |
          dnf -y update
          dnf -y groupinstall "Development Tools"
          dnf -y install git make tar gzip which file

      - name: Checkout Redis source
        run: |
          git clone --depth 1 --branch "${{ inputs.redis_ref }}" https://github.com/redis/redis.git
          cd redis
          git rev-parse HEAD

      - name: Build redis-benchmark
        run: |
          cd redis
          make -j"$(nproc)" redis-benchmark
          echo "=== file ==="
          file src/redis-benchmark
          echo "=== ldd ==="
          ldd src/redis-benchmark || true
          echo "=== required GLIBC symbols (quick check) ==="
          strings -a src/redis-benchmark | grep -Eo 'GLIBC_[0-9]+\.[0-9]+' | sort -Vu | tail -n 20 || true

      - name: Package artifact
        run: |
          cd redis
          mkdir -p dist
          cp -f src/redis-benchmark dist/
          {
            echo "redis_ref=${{ inputs.redis_ref }}"
            echo "sha=$(git rev-parse HEAD)"
            echo "build_container=rockylinux:8 (glibc 2.28 baseline)"
            echo "arch=$(uname -m)"
          } > dist/build-info.txt

          tar -C dist -czf redis-benchmark-aarch64-glibc228-${{ inputs.redis_ref }}.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: redis-benchmark-aarch64-glibc228-${{ inputs.redis_ref }}
          path: redis-benchmark-aarch64-glibc228-${{ inputs.redis_ref }}.tar.gz
          if-no-files-found: error
          retention-days: 14
