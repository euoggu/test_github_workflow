name: build redis-benchmark aarch64 (glibc 2.28)

on:
  workflow_dispatch:
    inputs:
      redis_ref:
        description: "Redis tag/branch/commit (e.g. 7.4.0)"
        required: false
        default: "7.4.0"

jobs:
  build:
    name: build redis-benchmark (aarch64, glibc 2.28 baseline)
    runs-on: ubuntu-24.04-arm

    container:
      image: registry.access.redhat.com/ubi8/ubi-minimal:8.10

    steps:
      - name: Show environment
        run: |
          set -eux
          uname -a
          cat /etc/os-release || true
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          pwd
          ls -lah

      - name: Install build deps (UBI8 minimal)
        run: |
          set -euxo pipefail
          microdnf -y update
          microdnf -y install \
            git make gcc gcc-c++ glibc-devel \
            tar gzip which file \
            findutils diffutils

      - name: Checkout Redis source
        run: |
          set -euxo pipefail
          git clone --depth 1 --branch "${{ inputs.redis_ref }}" https://github.com/redis/redis.git
          cd redis
          git rev-parse HEAD

      - name: Build redis-benchmark
        run: |
          set -euxo pipefail
          cd redis
          make -j"$(nproc)" redis-benchmark
          file src/redis-benchmark
          ldd src/redis-benchmark || true
          # quick check what GLIBC versions the binary references
          strings -a src/redis-benchmark | grep -Eo 'GLIBC_[0-9]+\.[0-9]+' | sort -Vu | tail -n 50 || true

      - name: Package artifact (to workspace/out)
        run: |
          set -euxo pipefail
          cd redis

          mkdir -p dist
          cp -f src/redis-benchmark dist/

          {
            echo "redis_ref=${{ inputs.redis_ref }}"
            echo "sha=$(git rev-parse HEAD)"
            echo "build_container=registry.access.redhat.com/ubi8/ubi-minimal:8.10 (glibc 2.28 baseline)"
            echo "arch=$(uname -m)"
          } > dist/build-info.txt

          mkdir -p "$GITHUB_WORKSPACE/out"
          tar -C dist -czf "$GITHUB_WORKSPACE/out/redis-benchmark-aarch64-glibc228-${{ inputs.redis_ref }}.tar.gz" .

          echo "=== out dir ==="
          ls -lah "$GITHUB_WORKSPACE/out"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: redis-benchmark-aarch64-glibc228-${{ inputs.redis_ref }}
          path: out/redis-benchmark-aarch64-glibc228-${{ inputs.redis_ref }}.tar.gz
          if-no-files-found: error
          retention-days: 14
