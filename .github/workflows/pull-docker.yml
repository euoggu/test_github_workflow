name: pull-docker

on:
  workflow_dispatch:
    inputs:
      architecture:
        description: "目标架构"
        type: choice
        options:
          - arm64
          - amd64
        default: arm64
        required: true
      image_list:
        description: >-
          使用空格、逗号、回车或文字 \\n 分隔多个镜像（可在镜像后追加 |别名 来指定保存文件名）
        type: string
        required: true
      retention_days:
        description: "构建产物保留天数"
        type: string
        default: "7"
        required: false

permissions:
  contents: read

jobs:
  parse-images:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
    steps:
      - name: 解析镜像列表
        id: parse
        env:
          IMAGE_LIST: ${{ inputs.image_list }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
import json, os, re, sys

raw = os.environ.get("IMAGE_LIST", "")
raw = raw.replace("\r", "").replace("\\n", "\n")
parts = re.split(r"[,\s]+", raw)
items = []

for part in parts:
    token = part.strip()
    if not token or token.startswith("#"):
        continue
    image, alias = token, ""
    if "|" in token:
        image, alias = token.split("|", 1)
    image = image.strip()
    alias = alias.strip() or image
    if not image:
        continue
    safe_alias = re.sub(r"[^a-zA-Z0-9._-]+", "-", alias) or "image"
    items.append({
        "image": image,
        "alias": alias,
        "safe_alias": safe_alias,
    })

if not items:
    print("未提供有效的镜像列表", file=sys.stderr)
    sys.exit(1)

matrix_json = json.dumps(items)
with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
    fh.write(f"matrix={matrix_json}\n")
PY

  pull-and-save:
    needs: parse-images
    if: ${{ needs.parse-images.outputs.matrix != '' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        entry: ${{ fromJSON(needs.parse-images.outputs.matrix) }}
    env:
      TARGET_ARCH: ${{ inputs.architecture }}
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 拉取并保存镜像
        env:
          IMAGE_NAME: ${{ matrix.entry.image }}
          TAR_NAME: ${{ matrix.entry.safe_alias }}-${{ inputs.architecture }}.tar
        run: |
          set -euo pipefail
          mkdir -p artifacts
          echo "Pulling ${IMAGE_NAME} for linux/${TARGET_ARCH}"
          docker pull --platform "linux/${TARGET_ARCH}" "${IMAGE_NAME}"
          echo "Saving ${IMAGE_NAME} to artifacts/${TAR_NAME}"
          docker save -o "artifacts/${TAR_NAME}" "${IMAGE_NAME}"
          ls -lh "artifacts/${TAR_NAME}"

      - name: 上传镜像归档
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.entry.safe_alias }}-${{ inputs.architecture }}
          path: artifacts/${{ matrix.entry.safe_alias }}-${{ inputs.architecture }}.tar
          retention-days: ${{ inputs.retention_days }}
          if-no-files-found: error
          compression-level: 0
