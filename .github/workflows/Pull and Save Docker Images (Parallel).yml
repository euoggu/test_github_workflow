name: Pull and Save Docker Images (Parallel)

on:
  workflow_dispatch:
    inputs:
      images:
        description: '镜像列表（每行一个，格式：image:tag）'
        required: true
        type: string
      architecture:
        description: '选择 CPU 架构'
        required: true
        type: choice
        options:
          - linux/arm64
          - linux/amd64
      retention_days:
        description: 'Artifact 保留天数'
        required: true
        type: number

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      arch_suffix: ${{ steps.set-matrix.outputs.arch_suffix }}
    steps:
      - name: Generate matrix
        id: set-matrix
        run: |
          IMAGES=$(echo "${{ inputs.images }}" | grep -v '^$' | grep -v '^#' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "matrix={\"image\":$IMAGES}" >> $GITHUB_OUTPUT
          
          if [ "${{ inputs.architecture }}" = "linux/arm64" ]; then
            echo "arch_suffix=arm64" >> $GITHUB_OUTPUT
          else
            echo "arch_suffix=amd64" >> $GITHUB_OUTPUT
          fi

  pull-and-save:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false
    
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate filename
        id: filename
        run: |
          FILENAME=$(echo "${{ matrix.image }}" | sed 's/[\/:]/-/g')-${{ needs.prepare.outputs.arch_suffix }}
          echo "name=$FILENAME" >> $GITHUB_OUTPUT

      - name: Pull image
        run: docker pull --platform ${{ inputs.architecture }} "${{ matrix.image }}"

      - name: Save image
        run: |
          docker save -o ${{ steps.filename.outputs.name }}.tar "${{ matrix.image }}"
          ls -lh *.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.filename.outputs.name }}
          path: ${{ steps.filename.outputs.name }}.tar
          retention-days: ${{ inputs.retention_days }}
          compression-level: 0
